From: antirez <antirez@gmail.com>
Date: Mon, 11 Jun 2018 12:08:42 +0200
Subject: Security: fix redis-cli buffer overflow.

Thanks to Fakhri Zulkifli for reporting it.

The fix switched to dynamic allocation, copying the final prompt in the
static buffer only at the end.

Origin: upstream, https://github.com/antirez/redis/commit/9fdcc15962f9ff4baebe6fdd947816f43f730d50
diff --git a/src/redis-cli.c b/src/redis-cli.c
index 93a0900..cd26463 100644
--- a/src/redis-cli.c
+++ b/src/redis-cli.c
@@ -139,20 +139,23 @@ static long long mstime(void) {
 }
 
 static void cliRefreshPrompt(void) {
-    int len;
-
-    if (config.hostsocket != NULL)
-        len = snprintf(config.prompt,sizeof(config.prompt),"redis %s",
-                       config.hostsocket);
-    else
-        len = snprintf(config.prompt,sizeof(config.prompt),
-                       strchr(config.hostip,':') ? "[%s]:%d" : "%s:%d",
-                       config.hostip, config.hostport);
+    sds prompt = sdsempty();
+    if (config.hostsocket != NULL) {
+        sdscatfmt(prompt,"redis %s",config.hostsocket);
+    } else {
+        char addr[256];
+        snprintf(addr, sizeof(addr), strchr(config.hostip,':') ?
+           "[%s]:%d" : "%s:%d", config.hostip, config.hostport);
+        prompt = sdscatlen(prompt,addr,strlen(addr));
+    }
     /* Add [dbnum] if needed */
     if (config.dbnum != 0 && config.last_cmd_type != REDIS_REPLY_ERROR)
-        len += snprintf(config.prompt+len,sizeof(config.prompt)-len,"[%d]",
-            config.dbnum);
-    snprintf(config.prompt+len,sizeof(config.prompt)-len,"> ");
+        prompt = sdscatfmt(prompt,"[%i]",config.dbnum);
+
+    /* Copy the prompt in the static buffer. */
+    prompt = sdscatlen(prompt,"> ",2);
+    snprintf(config.prompt,sizeof(config.prompt),"%s",prompt);
+    sdsfree(prompt);
 }
 
 static sds getHistoryPath() {
